---
title: "Occupational Data"
author: "Rob Wells, Mary Hennigan, Katy Seiter, Abby Zimmardi and Rachell Sanchez-Smith" 
date: "4/21/2021"
output: pdf_document
---

#Many thanks to Sean Mussenden and Nicholas McMillon
#Many thanks to the Spring 2021 Advanced Reporting Class for Fact Checking: Robert Stewart, Haley Hale, Emma Dannenfelser, Caroline Sellers, Ravi Brock, Graham Smithson, Grayson Green

# Compilation of Occupational COVID-19 Reports for Calculations

# Part 1: Import Data, Clean It

```{r include=FALSE}
#install.packages("slider")
#install.packages("zoo")
#install.packages("gtools")
# vignette("basic-usage", package="googlesheets")
#install.packages("googledrive")
#install.packages("googlesheets4")
library(tidyverse)
library(janitor)
library(lubridate)
library(tidyr)
library(jsonlite)
library(gtools)
library(zoo)
library(reshape2)
library(slider)
library(rio)
library(dplyr)
```



#--------------------------------------------------------------------#
#--------------------------------------------------------------------#
#Part 1: Analysis
#--------------------------------------------------------------------#
#--------------------------------------------------------------------#

#Import worker_illness_cleaned_master which has a Unique ID from github

```{r}
cleaned_master <- rio::import("https://raw.githubusercontent.com/profrobwells/Spring2021Data/main/worker_illness_cleaned_master.csv")

cleaned_master$date <- as.Date(cleaned_master$date)
glimpse(cleaned_master)
```
#fix Uniqueid of Nebo Poultry in yell-pope create at #146 instead of #2
 df["rowName", "columnName"] <- value
 df[df$serial.id==5, "gender"] <- 1
```{r}
#Nebo Poultry, "yell, pope" gets own ID
cleaned_master[4,1] <- 146
cleaned_master[5,1] <- 146
#George's Kansas Street gets own ID
cleaned_master[101,1] <- 147


```


```{r}
#totals per worksite
company_site_totals <- cleaned_master %>% 
  select(cleaned_company, cleaned_county, Uniqueid, date, total_number_of_cases) %>% 
  group_by(Uniqueid) %>% 
  filter(total_number_of_cases == max(total_number_of_cases)) %>% 
  filter(date == max(date))

sum(company_site_totals$total_number_of_cases)

#write.csv(company_site_totals, "company_site_totals.csv")
glimpse(company_site_totals)
```

#Revision: 9,065 cases total cases of infected employees in Arkansas workplaces. 
#Previous: 11,103, 9158, 8,921 

#totals per worksite per month
#this created max number of each worksite by year and month
```{r}
maxworksite_month <- cleaned_master %>% 
   select(cleaned_company, date, yearmon, Uniqueid, cleaned_county, total_number_of_cases) %>% 
  group_by(cleaned_company, Uniqueid, yearmon) %>%  
  top_n(1, date) 

maxworksite_month <- maxworksite_month %>% 
  select(cleaned_company, total_number_of_cases, Uniqueid, cleaned_county, date, yearmon) %>% 
  arrange((Uniqueid))

maxworksite_month 
write.csv(maxworksite_month, "maxworksite_month.csv")
```

#Calculate New Cases by subtracting workplaces by previous month
```{r}

maxworksite_month <- as.data.frame(maxworksite_month)

test <- maxworksite_month %>%
  arrange(Uniqueid, date) %>%  
  mutate(New_Cases = (total_number_of_cases-lag(total_number_of_cases)))  
#calculation creates erroneous value for first

#Create new df with only the first values
test1 <- test %>% 
  select(cleaned_company, Uniqueid, total_number_of_cases, cleaned_county, date, yearmon, New_Cases) %>% 
  group_by(Uniqueid) %>% 
  filter(date == min(date)) 

#replace first value in New_Cases with first total case
test2 <- test1 %>% 
  mutate(New_Cases =(total_number_of_cases)) %>% 
  mutate(FIRST=("FIRST")) %>% 
  ungroup()


#Create second df deleting all first values
no_first <- test %>% 
  select(cleaned_company, Uniqueid, total_number_of_cases, cleaned_county, date, yearmon, New_Cases) %>% 
  group_by(Uniqueid) %>% 
  filter(date > min(date)) %>% 
  ungroup()

#Align in dataframes
no_first <- as.data.frame(no_first)
test2 <- as.data.frame(test2)

#Combine in new dataframe
new_cases <- gtools::smartbind(test2,no_first)

new_cases <- new_cases %>% 
  arrange(Uniqueid)

write.csv(new_cases, "new_cases_april_27.csv")

sum(new_cases$New_Cases)
#9021 total for the new cases
#Difference of 44 from the 9,065 total cases. 
#Partly due Twin Rivers #39, went from 160 total cases on Dec. 21 to 122 on Jan 18, down -38.
#
```

```{r}
#New summary by month
monthsum <- new_cases %>%
   select(cleaned_county, yearmon, New_Cases) %>% 
   group_by(yearmon) %>% 
   summarize(month_total=sum(New_Cases))  
  
write.csv(monthsum, "monthsum_april27.csv")
sum(monthsum$month_total)
```

#Revised: New cases per facility, county totals - April 27
```{r}
countysum3 <- new_cases %>%
   select(cleaned_county, New_Cases, yearmon) %>% 
   group_by(cleaned_county, yearmon) %>% 
   summarize(county_total=sum(New_Cases))  
  
sum(countysum3$county_total)

write.csv(countysum3, "countysum_April27.csv")
```



```{r}
company_site_totals <- cleaned_master %>% 
  select(cleaned_company, cleaned_county, Uniqueid, date, total_number_of_cases) %>% 
  group_by(Uniqueid) %>% 
  filter(total_number_of_cases == max(total_number_of_cases)) %>% 
  filter(date == max(date))

sum(company_site_totals$total_number_of_cases)

#write.csv(company_site_totals, "company_site_totals.csv")
glimpse(company_site_totals)
```

```{r}
#totals per company
companytotals <- company_site_totals  %>% 
  group_by(cleaned_company) %>% 
  summarize(total=sum(total_number_of_cases)) %>% 
  mutate(percent = total / sum(total)) %>% 
  arrange(desc(total))

companytotals$percent <- formattable::percent(companytotals$percent)

companytotals


write.csv(companytotals, "company_totals.csv")
#Feeds this Datawrapper table: https://www.datawrapper.de/_/N2CYu/
```

#company with the highest monthly totals  
```{r}
monthcototals <- cleaned_master %>% 
  select(cleaned_company, date, yearmon, Uniqueid, cleaned_city, cleaned_county, total_number_of_cases) %>% 
  group_by(yearmon) %>% 
  filter(total_number_of_cases == max(total_number_of_cases)) %>% 
  filter(yearmon == max(yearmon)) %>% 
  arrange(desc(yearmon))
write.csv(monthcototals, "monthcostotals.csv")
```

#max of each worksite by yearmon
```{r}
maxworksite_month1 <- cleaned_master %>% 
  select(cleaned_company, date, yearmon, Uniqueid, cleaned_city, cleaned_county, total_number_of_cases) %>% 
  group_by(cleaned_company, Uniqueid, yearmon) %>% 
  filter(total_number_of_cases == max(total_number_of_cases)) 
maxworksite_month1
```



#Stopped 8:50 am April 27
#Stopped 8:50 am April 27
#NOTES BELOW
#NOTES BELOW
#NOTES BELOW
#NOTES BELOW







#PROBLEMS WITH A monthly time series
```{r}
#per month totals per county for a time series
# month4_totals <- cleaned_master %>% 
#   mutate(yearmon = format(date, "%Y-%m")) %>%
#  select(cleaned_county, Uniqueid, yearmon, date, total_number_of_cases) %>% 
#   group_by(Uniqueid, cleaned_county, yearmon) %>% 
#   filter(total_number_of_cases == max(total_number_of_cases)) %>% 
#   filter(date == max(date))
# 
# month5_totals <- month4_totals %>% 
#   select(cleaned_county, yearmon, total_number_of_cases) %>% 
#   group_by(cleaned_county, yearmon) %>%
#   summarize(total=sum(total_number_of_cases))

#write.csv(month5_totals, "monthsum_April26.csv")

```


#Revised Total number of cases in a county for the entire dataset - April 26
```{r}
countysum3 <- month4_totals %>%
   group_by(cleaned_county, Uniqueid) %>%
   filter(total_number_of_cases == max(total_number_of_cases)) %>% 
   summarize(total=sum(total_number_of_cases)) %>% 
   ungroup() %>% 
   select(cleaned_county, total) %>% 
   group_by(cleaned_county) %>% 
   summarize(county_total=sum(total))  
  

sum(countysum3$county_total)

#write.csv(countysum3, "countysum_April26.csv")
```



#PROBLEMS WITH A monthly time series
#total by month
```{r}
monthsum <- month4_totals %>%
   select(cleaned_county, yearmon, Uniqueid, total_number_of_cases) %>% 
   group_by(cleaned_county, yearmon, Uniqueid) %>%
   filter(total_number_of_cases == max(total_number_of_cases)) %>% 
   summarize(total=sum(total_number_of_cases)) %>% 
   ungroup() %>% 
   select(yearmon, total) %>% 
   group_by(yearmon) %>% 
   summarize(county_total=sum(total))  
  

sum(monthsum$county_total)

#write.csv(monthsum, "countysum_April26.csv")
```



#internal check
```{r}
check <- cleaned_master %>% 
  select(cleaned_company, date, yearmon, Uniqueid, cleaned_county, total_number_of_cases) %>% 
  group_by(cleaned_company, Uniqueid, yearmon) %>% 
  top_n(1, date) %>% 
  #top_n(1, cleaned_county) #yields duplicates %>% 
  ungroup() %>% 
  select(cleaned_company, Uniqueid, cleaned_county, yearmon) %>% 
  group_by(cleaned_company, Uniqueid, yearmon) %>% 
  count()
check
```

#this created max number of each worksite by year and month
```{r}
maxworksite_month <- cleaned_master %>% 
   select(cleaned_company, date, yearmon, Uniqueid, cleaned_county, total_number_of_cases) %>% 
  group_by(cleaned_company, Uniqueid, yearmon) %>%  
  top_n(1, date) 
maxworksite_month 
write.csv(maxworksite_month, "maxworksite_month.csv")
```

#total number of cases in a county
```{r}
countysum <- maxworksite_month %>% 
  group_by(cleaned_county, yearmon) %>% 
  summarize(total_cases=sum(total_number_of_cases))
 

#write.csv(countysum, "countysum.csv")
glimpse(countysum)
```


#total number of cases in a county for a year
# ```{r}
# countysum2 <- countysum %>% 
#   group_by(cleaned_county) %>% 
#   summarize(All_Worker_Covid_Cases=sum(total_cases))
#  
# 
# write.csv(countysum2, "countysum2.csv")
# 
# sum(countysum2$All_Worker_Covid_Cases)
# 
# ```

#county total case reports in a county
```{r}
month_counts <-cleaned_master %>%
  select(date,cleaned_city, cleaned_county, cleaned_company, month) %>% 
  group_by(month) %>% 
  count() %>% 
  arrange(desc(n))
month_counts
write.csv(month_counts,"month_counts.csv")

#Refined: July 139; June 135; Dec 110, Aug 108
#Notes: June, 147, July, 142, Dec, 110 and Aug, 109 are the top months and only months above 100.
```

```{r}
dates <- cleaned_master %>% 
  select(date, cleaned_company, number_active_cases) %>% 
  group_by(date) %>% 
  summarise(total = sum(number_active_cases)) %>% 
  arrange(desc(date))

dates
write.csv (dates,"active_cases_dates.csv")
```


#City Analysis
#Top Ten Cities Chart https://public.flourish.studio/visualisation/5527182/ 
```{r}
cleaned_city_report <- cleaned_master %>% 
  select(date, cleaned_city) %>% 
  group_by(cleaned_city) %>% 
  count() %>% 
  arrange(desc(n)) 

cleaned_city_report

#write.csv(cleaned_city_report, "cleaned_city_report.csv")

#Report shows Springdale, 73; Jonesboro, 61; Rogers, 60

```

#County Analysis
#Top Ten Counties Chart https://public.flourish.studio/visualisation/5527376/ 
```{r}
#Analyze records by county location
cleaned_county_report <- cleaned_master %>% 
  select(date,cleaned_county) %>% 
  group_by(cleaned_county) %>% 
  count() %>% 
  arrange(desc(n))

cleaned_county_report

write.csv(cleaned_county_report, "cleaned_county_report.csv")

#WELLS NOTE: Two of the wealthiest counties in Arkansas have the highest number of occupational reports

#New: Benton, 97; Washington 89; Pope 68; Craighead 61 are the top counties
#Old: Benton, 95; Washington 83; Pope 68;Craighead 56 are the top counties.
```

#----------------------------------------------------------------------------
#  Calculate Worker Covid Cases as Percentage of All Community Cases By Month
#----------------------------------------------------------------------------

## Import master file from Arkansascovid data
```{r}
master2 <- rio::import("https://raw.githubusercontent.com/Arkansascovid/Main/master/master_file.csv")
## Subset dataframe and assign months
test <- master2 %>% 
  select(county_nam, mydate, New_Cases_Today, positive, confirmed_pos) %>% 
  filter(county_nam!="Arkansas_all_counties") %>% 
  filter(county_nam!="MissingCountyInfo") %>% 
  filter(mydate >= "2020-04-09" & mydate <= "2021-04-15")

#Process dates** 
test$date <- ymd(test$mydate)
test$year <- year(test$date)
test$month <- month(test$date, label=TRUE)

test <- test %>% 
  mutate(yearmon = format(date, "%Y-%m"))

```

#combine the positive (confirmed and probable from Sept 13 forward) with the confirmed_pos (Sept 12 and earlier) into a new column called positive2
```{r}
test2 <- test %>% 
  filter(date <= "2020-09-12") %>% 
  mutate(Total_Positive = (confirmed_pos))


test3 <- test %>% 
  filter(date > "2020-09-12") %>% 
  mutate(Total_Positive = (positive))

test <- smartbind(test2, test3)
test$date <- ymd(test$mydate)
glimpse(test)


```
#Clean the county names

```{r}
test <- test %>%
  mutate(cleaned_county = tolower(county_nam)) %>%
  mutate(cleaned_county = case_when(
    str_detect(cleaned_county, "little") ~ "little_river",
    str_detect(cleaned_county, "van") ~ "van_buren",
    str_detect(cleaned_county, "fishing") ~ "st. francis",
    str_detect(cleaned_county, "and recreation") ~ "faulkner",
    # str_detect(cleaned_county, "ar ") ~ "crittenden",
    TRUE ~ cleaned_county
  ))

test$cleaned_county <- str_trim(test$cleaned_county) 
```


## Calculations ##



## Master counties and months table, May 2020 - April 2021 ##
```{r}
master_counties_months <- test %>%
  group_by(yearmon, cleaned_county, Total_Positive) %>%
  summarise(xnewcases=sum(New_Cases_Today)) %>% 
  top_n(1, Total_Positive)
glimpse(master_counties_months)

#New cases today calculation sometimes will not total for the August-September period when the antigen totals came in. the positive2 is the best total instead since it had the antigen whereas New Cases didn't always have the antigen until After Sept. 14
#This is why I use the calculation of subtracting the postive2 total below to acquire the best New Cases for a time series.
```


#Calculate New Cases by subtracting months
```{r}
master_counties_months <- as.data.frame(master_counties_months)

master_counties_months <- master_counties_months %>%
  arrange(cleaned_county) %>%  
  mutate(New_Cases = (Total_Positive-lag(Total_Positive))) %>% 
  filter(yearmon!="2020-04")
#We cut April 2020 since this month is subtracted from the previous entry, April 2021, giving an erroneous value

write.csv(master_counties_months, "master_counties_months.csv")
glimpse(master_counties_months)
```

#Combine with countysum from Occupational Data

```{r}
zzz <- countysum %>% 
  inner_join(master_counties_months, by=c("cleaned_county"="cleaned_county", "yearmon"="yearmon")) %>% 
    rename(Year_Month = yearmon, County = cleaned_county, Worker_Covid = total_cases)

zzz <- zzz %>% 
  select(Year_Month, County, Worker_Covid, Total_Positive, New_Cases)

glimpse(zzz)
```

#calculate ratio of reported workplace outbreaks to total covid cases in a county
#The companies that appear on the monthly reports represent cumulative totals
#Worker Community_New_Case is Monthly Cumulative total of the companies reporting / New Cases in Community
#Worker_Cumulative_Pct is Monthly Cumulative total of the companies reporting / Monthly Cumulative Positive in Community
```{r}
occupation_month <- zzz %>% 
  mutate(Worker_Community_New_Case_Pct = (Worker_Covid/New_Cases)) %>% 
  mutate(Worker_Cumulative_Pct = (Worker_Covid/Total_Positive))  

occupation_month$Worker_Community_New_Case_Pct <- formattable::percent(occupation_month$Worker_Community_New_Case_Pct)

occupation_month$Worker_Cumulative_Pct <- formattable::percent(occupation_month$Worker_Cumulative_Pct)

write.csv(occupation_month, "occupation_month.csv")
#feeds this graphic: https://app.flourish.studio/visualisation/5847959/edit?
```




#Company Analysis
#Top 10 Companies Chart needs work: 
#Revised Look at the company names 
#add the function that produces percent of the whole - Hennigan can't figure out the funciton

```{r}
cleaned_company_report <- cleaned_master %>% 
  count(cleaned_company) %>% 
  arrange(desc(n)) 

cleaned_company_report
write.csv(cleaned_company_report, "cleaned_company_report.csv")
  

##Company analysis shows Tyson 281 (289 previously); George's 41; ConAgra 40; Simmons Foods 40 (Possible 40 with one more cleaning); Peco 37


#TOTAL NUMBER OF ARK STATE HEATH DEPT REPORTS PER COMPANY SINCE MAY 19, 2020 (814)
#SIX OF TEN ARE POULTRY PROCESSING
#TYSON IS 32% OF ALL REPORTS
```


