---
title: "Monthly New Cases - All Counties"
author: "Rob Wells & Katy Seiter"
date: "4/13/2021"
output: html_document
---

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(rio)
library(lubridate)
library(dplyr)
```

## Import master file from Arkansascovid data
```{r}
master2 <- rio::import("https://raw.githubusercontent.com/Arkansascovid/Main/master/master_file.csv")
## Subset dataframe and assign months
test <- master2 %>% 
  select(county_nam, mydate, New_Cases_Today, positive, confirmed_pos) %>% 
  filter(county_nam!="Arkansas_all_counties") %>% 
  filter(county_nam!="MissingCountyInfo") %>% 
  filter(mydate >= "2020-04-09" & mydate <= "2021-04-15")

#Process dates** 
test$date <- ymd(test$mydate)
test$year <- year(test$date)
test$month <- month(test$date, label=TRUE)

test <- test %>% 
  mutate(yearmon = format(date, "%Y-%m"))

```

#combine the positive (confirmed and probable from Sept 13 forward) with the confirmed_pos (Sept 12 and earlier) into a new column called positive2
```{r}
test2 <- test %>% 
  filter(date <= "2020-09-12") %>% 
  mutate(positive2 = (confirmed_pos))


test3 <- test %>% 
  filter(date > "2020-09-12") %>% 
  mutate(positive2 = (positive))

test <- smartbind(test2, test3)
test$date <- ymd(test$mydate)
glimpse(test)


```
#Clean the county names

```{r}
test <- test %>%
  mutate(cleaned_county = tolower(county_nam)) %>%
  mutate(cleaned_county = case_when(
    str_detect(cleaned_county, "little") ~ "little_river",
    str_detect(cleaned_county, "van") ~ "van_buren",
    str_detect(cleaned_county, "fishing") ~ "st. francis",
    str_detect(cleaned_county, "and recreation") ~ "faulkner",
    # str_detect(cleaned_county, "ar ") ~ "crittenden",
    TRUE ~ cleaned_county
  ))

test$cleaned_county <- str_trim(test$cleaned_county) 
```


## Calculations ##



## Master counties and months table, April 2020 - March 2021 ##
```{r}
master_counties_months <- test %>%
  group_by(yearmon, cleaned_county, positive2) %>%
  summarise(New_Cases=sum(New_Cases_Today)) %>% 
  top_n(1, positive2)

write.csv(master_counties_months, "master_counties_months.csv")
names(master_counties_months)

```


#Import countysum from Occupational Data


```{r}
zzz <- countysum %>% 
  inner_join(master_counties_months, by=c("cleaned_county"="cleaned_county", "yearmon"="yearmon"))
glimpse(zzz)
```



#calculate ratio of reported workplace outbreaks to total covid cases in a county
```{r}
occupation_month <- zzz %>% 
  mutate(ratio_occupation = (total_cases/New_Cases)) %>% 
  mutate(ratio_occup_positive = (total_cases/positive2)*100)
write.csv(occupation_month, "occupation_month.csv")
```



#------------------------------------------------------------------------------------
#------------------------------------------------------------------------------------

#This section is no longer needed
#This section is no longer needed

#This section is no longer needed

#This section is no longer needed
```{r}
# library(tidyr)
# library(dplyr)
# library(readr)
counties_months <- master_counties_months %>% 
  pivot_wider(names_from = yearmon,
  values_from = New_Cases)

counties_months <- janitor::clean_names(counties_months)
counties_months
```





#Math
```{r}
counties_months <- counties_months %>% 
  mutate(MayPct = (x2020_05-x2020_04)/x2020_04) %>% 
  mutate(JunePct = (x2020_06-x2020_05)/x2020_05) %>% 
  mutate(JulyPct = (x2020_07-x2020_06)/x2020_06) %>% 
  mutate(AugPct = (x2020_08-x2020_07)/x2020_07) %>% 
  mutate(SepPct = (x2020_09-x2020_08)/x2020_08) %>% 
  mutate(OctPct = (x2020_10-x2020_09)/x2020_09) %>% 
  mutate(NovPct = (x2020_11-x2020_10)/x2020_10) %>%
  mutate(DecPct = (x2020_12-x2020_11)/x2020_11) %>%
  mutate(JanPct = (x2021_01-x2020_12)/x2020_12) %>%
  mutate(FebPct = (x2021_02-x2021_01)/x2021_01) %>%
  mutate(MarPct = (x2021_03-x2021_02)/x2021_02) 


counties_months <- counties_months %>% 
  mutate(MayNew = (x2020_05-x2020_04)) %>% 
  mutate(JuneNew = (x2020_06-x2020_05)) %>% 
  mutate(JulyNew = (x2020_07-x2020_06)) %>% 
  mutate(AugNew = (x2020_08-x2020_07)) %>% 
  mutate(SepNew = (x2020_09-x2020_08)) %>% 
  mutate(OctNew = (x2020_10-x2020_09)) %>% 
  mutate(NovNew = (x2020_11-x2020_10)) %>%
  mutate(DecNew = (x2020_12-x2020_11)) %>%
  mutate(JanNew = (x2021_01-x2020_12)) %>%
  mutate(FebNew = (x2021_02-x2021_01)) %>%
  mutate(MarNew = (x2021_03-x2021_02)) 

```



```{r}
#import Occupational data cleaned master March 26 version
occupational <- rio::import("https://raw.githubusercontent.com/profrobwells/Spring2021Data/main/cleaned_master.csv")

#Process dates** 
# occupational$date <- ymd(occupational$date)
# occupational$year <- year(occupational$date)
# occupational$month <- month(occupational$date, label=TRUE)
# occupational$yearmon <- format(occupational$date, "%Y-%m")

#occupational <- occupational[ -c(1,2) ]
glimpse(occupational)
```


## Mini tables: total new cases for each county by individual month ##
```{r}
april2020 <- master_counties_months %>% 
  select(county_nam, month, New_Cases) %>% 
  filter(month=="Apr")
#write.csv(april2020, "april2020.csv") 

may2020 <- master_counties_months %>% 
  select(county_nam, month, New_Cases) %>% 
  filter(month=="May")
#write.csv(may2020, "may2020.csv") 

june2020 <- master_counties_months %>% 
  select(county_nam, month, New_Cases) %>% 
  filter(month=="Jun")
#write.csv(june2020, "june2020.csv") 

july2020 <- master_counties_months %>% 
  select(county_nam, month, New_Cases) %>% 
  filter(month=="Jul")
#write.csv(july2020, "july2020.csv") 

aug2020 <- master_counties_months %>% 
  select(county_nam, month, New_Cases) %>% 
  filter(month=="Aug")
#write.csv(aug2020, "aug2020.csv") 

sept2020 <- master_counties_months %>% 
  select(county_nam, month, New_Cases) %>% 
  filter(month=="Sep")
#write.csv(sept2020, "sept2020.csv") 

oct2020 <- master_counties_months %>% 
  select(county_nam, month, New_Cases) %>% 
  filter(month=="Oct")
#write.csv(oct2020, "oct2020.csv") 

nov2020 <- master_counties_months %>% 
  select(county_nam, month, New_Cases) %>% 
  filter(month=="Nov")
#write.csv(nov2020, "nov2020.csv") 

dec2020 <- master_counties_months %>% 
  select(county_nam, month, New_Cases) %>% 
  filter(month=="Dec")
#write.csv(dec2020, "dec2020.csv") 

jan2021 <- master_counties_months %>% 
  select(county_nam, month, New_Cases) %>% 
  filter(month=="Jan")
#write.csv(jan2021, "jan2021.csv") 

feb2021 <- master_counties_months %>% 
  select(county_nam, month, New_Cases) %>% 
  filter(month=="Feb")
#write.csv(feb2021, "feb2021.csv") 

march2021 <- master_counties_months %>% 
  select(county_nam, month, New_Cases) %>% 
  filter(month=="Mar")
#write.csv(march2021, "march2021.csv") 
```